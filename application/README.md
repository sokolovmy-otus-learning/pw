# Сервис сокращения ссылок

Лёгкий и масштабируемый сервис для сокращения URL, построенный на FastAPI, Aerospike и Nginx. Имеет современный интерфейс в стиле Google, который адаптируется к светлой или тёмной теме системы.

## Возможности

- **Сокращение ссылок**: Создание коротких 6-символьных URL (base62) из длинных ссылок.
- **Редирект**: Перенаправление с коротких ссылок на оригинальные URL.
- **Информация о ссылке**: Получение данных о короткой ссылке, включая оригинальный URL и время жизни (TTL).
- **Управление TTL**: Ссылки истекают через заданное время (по умолчанию 24 часа), TTL обновляется при обращении.
- **Адаптивный дизайн**: Интерфейс с чистым дизайном в стиле Google, использующий Tailwind CSS и шрифт Roboto, поддерживает светлую и тёмную темы в зависимости от настроек системы.
- **Масштабируемая архитектура**: Контейнеризировано с помощью Docker, использует FastAPI для API, Aerospike для хранения данных и Nginx для обслуживания статических файлов и проксирования запросов.

## Структура проекта

```
url-shortener/
├── link-service/               # Сервис API для создания и получения коротких ссылок
│   ├── Dockerfile
│   ├── main.py
│   ├── requirements.txt
├── redirect-service/           # Сервис для обработки редиректов
│   ├── Dockerfile
│   ├── main.py
│   ├── requirements.txt
├── frontend-service/           # Фронтенд-сервис
│   ├── Dockerfile
│   ├── index.html
│   ├── 05-envsubst-template.sh
├── nginx/                      # Конфигурация Nginx
│   ├── nginx.conf
├── docker-compose.yml          # Конфигурация Docker Compose
├── README.md                   # Этот файл
```

## Требования

- Установленные **Docker** и **Docker Compose**.
- Доступ в интернет для загрузки Docker-образов и шрифтов Google Fonts.

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone <url-репозитория>
   cd url-shortener
   ```

2. **Проверьте структуру проекта**, чтобы она соответствовала указанной выше.

3. **Соберите и запустите сервисы**:
   ```bash
   docker-compose up --build
   ```
   Это:
   - Соберёт образы для `link-service`, `redirect-service` и `frontend-service`.
   - Загрузит образы `aerospike:ce-8.0.0.7_1` и `nginx:1.28.0-alpine-slim`.
   - Запустит все сервисы (Nginx, FastAPI API, Aerospike) в сетевом мосту.

4. **Откройте приложение**:
   - Перейдите по адресу `http://localhost` в браузере.
   - Интерфейс автоматически адаптируется к системной теме (светлой или тёмной).

## Использование

### Веб-интерфейс
1. **Сокращение ссылки**:
   - Введите действительный URL (например, `https://example.com`) в поле ввода.
   - Нажмите кнопку "Shorten URL".
   - Появится короткая ссылка (например, `http://localhost/AbCdEf`), на которую можно кликнуть или ее скопировать.
2. **Копирование короткой ссылки**:
   - Нажмите на иконку копирования рядом с короткой ссылкой, чтобы скопировать её в буфер обмена.
3. **Редирект**:
   - Перейдите по короткой ссылке (например, `http://localhost/AbCdEf`), чтобы попасть на оригинальный URL.
4. **Обработка ошибок**:
   - При вводе некорректного URL или сбое отображается сообщение об ошибке красным цветом.

### API
Сервис `link-service` предоставляет два endpoint'а под `/api/`:
- **POST `/api/shorten`**:
  - Запрос: `{"url": "https://example.com"}`
  - Ответ: `{"shortId": "AbCdEf", "shortUrl": "/AbCdEf"}`
  - Пример:
    ```bash
    curl -X POST http://localhost/api/shorten -H "Content-Type: application/json" -d '{"url":"https://example.com"}'
    ```
- **GET `/api/links/{shortId}`**:
  - Ответ: `{"shortId": "AbCdEf", "originalUrl": "https://example.com", "ttl": 86399, "prettyTtl": "23 hours, 59 minutes, 59 seconds"}`
  - Пример:
    ```bash
    curl http://localhost/api/links/AbCdEf
    ```

Сервис `redirect-service` обрабатывает:
- **GET `/{shortId}`**:
  - Перенаправляет на оригинальный URL, хранящийся в Aerospike.
  - Обновляет TTL при обращении.
  - Пример:
    ```bash
    curl -v http://localhost/AbCdEf
    ```

## Конфигурация

- **Переменные окружения** (указаны в `docker-compose.yml`):
  - `LINK_TTL_SECONDS`: Время жизни ссылок (по умолчанию: 86400 секунд = 24 часа).
  - `UVICORN_WORKERS`: Количество воркеров Uvicorn (по умолчанию: 4).
  - `ROOT_PATH`: Префикс API для `link-service` (по умолчанию: `/api`).
  - `PORT`: Порт для сервисов (8000 для `link-service`, 8001 для `redirect-service`, 9000 для `frontend-service`).
  - `AEROSPIKE_HOSTS`: Хосты Aerospike (по умолчанию: `aerospike`).
  - `AEROSPIKE_PORT`: Порт Aerospike (по умолчанию: 3000).
  - `AEROSPIKE_NAMESPACE`: Пространство имен Aerospike (по умолчанию: `links`).
- **Aerospike**:
  - Настроен для хранения данных в томе `aerospike-data`.
- **Nginx**:
  - Обслуживает фронтенд из `/usr/share/nginx/html`.
  - Проксирует запросы `/api/` к `link-service` и короткие ссылки (`/[a-zA-Z0-9]{6}`) к `redirect-service`.

## Настройка

### Фронтенд
- **API URL**:
  - Переменная `API_SHORTEN_URI` задаёт путь для API (по умолчанию: `/api/shorten`).
- **Тема**:
  - Интерфейс использует палитру Google (`#4285F4`, `#FBBC05`, `#EA4335`) и шрифт **Roboto**.
  - Светлая тема: фон `#F1F3F4`, белый контейнер.
  - Тёмная тема: фон `#202124`, контейнер `#303134`.

### Бэкенд
- **TTL**:
  - Измените `LINK_TTL_SECONDS` в `docker-compose.yml` для настройки времени жизни (например, `172800` для 48 часов).
- **Длина shortId**:
  - Измените функцию `generate_short_id` в `link-service/main.py` для изменения длины (например, 8 символов).

## Разработка

Для внесения изменений и тестирования:
1. Обновите файлы (например, `index.html`, `main.py`).
2. Пересоберите и перезапустите:
   ```bash
   docker-compose down
   docker-compose up --build
   ```
3. Отладка:
   - Просмотрите логи: `docker-compose logs <сервис>` (например, `link-service`, `nginx`).
   - Проверьте Aerospike: `docker exec -it aerospike aql`.
   - Используйте DevTools браузера для проблем с фронтендом.

## Замечания
- **Безопасность**: Для продакшена добавьте HTTPS (например, через Let's Encrypt) и настройте Aerospike для использования пароля.
- **Производительность**: Увеличьте `UVICORN_WORKERS` для высокой нагрузки.
- **Сохранность данных**: Данные Aerospike хранятся в томе `aerospike-data` и сохраняются между перезапусками.

## Лицензия
MIT License. Используйте и модифицируйте свободно.